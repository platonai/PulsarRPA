# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºé˜¶æ®µ
FROM maven:3.9.9-eclipse-temurin-21-alpine AS builder

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /build

# å¤åˆ¶é¡¹ç›®çš„ Maven ç›¸å…³æ–‡ä»¶ï¼ˆé¿å…æ‹·è´æºç å¯¼è‡´ç¼“å­˜å¤±æ•ˆï¼‰
COPY ../../pom.xml .
# ä¸‹è½½æ‰€æœ‰ä¾èµ–å¹¶è¿›è¡Œç¼–è¯‘ï¼ˆå¦‚æœä¾èµ–æ²¡æœ‰å˜ï¼Œåˆ™ä¼šä½¿ç”¨ç¼“å­˜ï¼‰
RUN mvn dependency:go-offline -B

# å¤åˆ¶æ•´ä¸ªé¡¹ç›®
COPY ../.. .

RUN ls -l

# æ„å»ºåº”ç”¨
RUN mvn clean install -Pall-modules -DskipTests \
    -Dmaven.javadoc.skip=true \
    -Dmaven.source.skip=true

# å¤åˆ¶ JAR ä»¥ä¾¿åœ¨ä¸‹ä¸€é˜¶æ®µä½¿ç”¨
RUN cp $(find /build -name "*.jar" | grep "PulsarRPA.jar") /build/app.jar

# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œé˜¶æ®µ
FROM eclipse-temurin:21-jre-alpine AS runner

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# è®¾ç½®æ—¶åŒº
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

RUN apk add curl
# å®‰è£… Chromium å’Œå¿…è¦çš„ä¾èµ–
RUN apk add --no-cache \
    chromium \
    nss \
    freetype \
    freetype-dev \
    harfbuzz \
    ca-certificates \
    ttf-freefont

# è®¾ç½® Chromium ç¯å¢ƒå˜é‡
ENV CHROME_BIN=/usr/bin/chromium-browser \
    CHROME_PATH=/usr/lib/chromium/ \
    PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true \
    PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /build/app.jar app.jar

ENV BROWSER_DISPLAY_MODE=HEADLESS \
    PRIVACY_AGENT_GENERATOR_CLASS=ai.platon.pulsar.skeleton.crawl.fetch.privacy.RandomPrivacyAgentGenerator

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV JAVA_OPTS="-Xms2G -Xmx10G -XX:+UseG1GC"

# æš´éœ²ç«¯å£
# 8182: api server
# 8082: H2 web server
# 9092: H2 TCP server

EXPOSE 8182

# åˆ›å»ºé root ç”¨æˆ·
RUN addgroup --system --gid 1001 appuser \
    && adduser --system --uid 1001 --ingroup appuser appuser

# è®¾ç½®ç›®å½•æƒé™
RUN chown -R appuser:appuser /app

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER appuser

# æ·»åŠ æ„å»ºå‚æ•°
LABEL maintainer="Vincent Zhang <ivincent.zhang@gmail.com>"
LABEL description="PulsarRPA: An AI-Enabled, Super-Fast, Thread-Safe Browser Automation Solution! ğŸ’–"

# å¯åŠ¨å‘½ä»¤ï¼Œæ”¯æŒåŠ¨æ€ç«¯å£é…ç½®
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
