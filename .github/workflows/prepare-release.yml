name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 4.4.0, 4.4.0-rc.1)'
        required: true
        type: string
      source_branch:
        description: 'Source branch for the release'
        required: false
        default: '4.4.x'
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-rc.N"
            echo "Examples: 4.4.0, 4.4.0-rc.1"
            exit 1
          fi
          
          echo "âœ… Version format is valid: $VERSION"

      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.source_branch }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update versions
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "ðŸ“ Updating version to $VERSION..."
          
          # Read current version (likely a SNAPSHOT version)
          CURRENT_VERSION=$(head -n 1 VERSION)
          
          # Write target release version to VERSION file
          echo "$VERSION" > VERSION
          
          # Replace version in project files
          # Use the same pattern as bin/release/update-versions.sh
          for FILE_PATTERN in 'pom.xml' 'llm-config.md' 'README.md' 'README.zh.md'; do
            find . -maxdepth 8 -name "$FILE_PATTERN" -type f | while read FILE; do
              if [ -f "$FILE" ]; then
                # Replace SNAPSHOT version with release version
                sed -i "s/$CURRENT_VERSION/$VERSION/g" "$FILE"
              fi
            done
          done
          
          echo "âœ… Version updated from $CURRENT_VERSION to $VERSION"

      - name: Commit version changes
        run: |
          git add -A
          
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit"
          else
            git commit -m "chore: bump version to ${{ github.event.inputs.version }}"
            git push origin ${{ github.event.inputs.source_branch }}
            echo "âœ… Version changes committed and pushed"
          fi

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
          
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$SOURCE_BRANCH" --base main --json number --jq '.[0].number' || echo "")
          
          if [ -n "$EXISTING_PR" ]; then
            echo "âš ï¸ PR #$EXISTING_PR already exists from $SOURCE_BRANCH to main"
            echo "PR URL: https://github.com/${{ github.repository }}/pull/$EXISTING_PR"
            exit 0
          fi
          
          # Create PR body
          cat > pr_body.md << 'EOF'
          ## ðŸš€ Release Preparation

          This PR prepares the release of version **${{ github.event.inputs.version }}**.

          ### ðŸ“‹ Pre-Merge Checklist

          - [ ] Version numbers updated correctly
          - [ ] CHANGELOG updated (if applicable)
          - [ ] All CI checks passing
          - [ ] Documentation updated (if needed)
          - [ ] Breaking changes documented (if any)

          ### ðŸ”„ Post-Merge Instructions

          After merging this PR to `main`, create the release tag:

          1. Go to [Create Release Tag workflow](https://github.com/${{ github.repository }}/actions/workflows/create-release-tag.yml)
          2. Click "Run workflow"
          3. Enter version: `${{ github.event.inputs.version }}`
          4. Click "Run workflow" button

          This will create tag `v${{ github.event.inputs.version }}` on main branch and trigger the release workflow.

          ---
          
          _Automated PR created by [prepare-release.yml](https://github.com/${{ github.repository }}/actions/workflows/prepare-release.yml)_
          EOF
          
          # Create the PR
          gh pr create \
            --base main \
            --head "$SOURCE_BRANCH" \
            --title "ðŸš€ Release v$VERSION" \
            --body-file pr_body.md \
            --label release
          
          echo "âœ… Pull request created successfully"
          
          # Get the PR URL
          PR_URL=$(gh pr list --head "$SOURCE_BRANCH" --base main --json url --jq '.[0].url')
          echo "PR URL: $PR_URL"
